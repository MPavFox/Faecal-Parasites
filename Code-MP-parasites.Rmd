---
title: "4rd chapter- parasites"
author: "Melissa Pavez-Fox"
date: "15/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(lubridate)
library(stringr)
library(tidyr)
library(magrittr)
library(readxl)
library(rstan)
library(dplyr)
library(igraph)
library(brms)
library(performance)#check model assumptions
library(beepr)#beeping
library(emmeans)#post-hoc conditional means
library(DHARMa)#model fit
library(bayestestR)#compute 89% CI
library(sjPlot)#extract tables
library(tidybayes)#Plot posteriors
library(reshape2)#Plot

```


Load data
```{r}

#Load parasite count
parasites <- read.csv("C:/Users/mp660/OneDrive - University of Exeter/PhD/4rd chapter/Data for Markdown/parasites_for_analyses.txt")

#Load Bison network metrics
networks = readRDS("C:/Users/mp660/OneDrive - University of Exeter/PhD/4rd chapter/Data for Markdown/for_bison/Bison_parasites.RData")

#Load demographic file
census <- read.csv("C:/Users/mp660/OneDrive - University of Exeter/PhD/3rd chapter/Data for Markdown/Census_Sep2020.csv")

#Directory for models
directory = "C:/Users/mp660/OneDrive - University of Exeter/PhD/4rd chapter/Data for Markdown/brms models/"

#Directory for edgelists
dir_edges = "C:/Users/mp660/OneDrive - University of Exeter/PhD/4rd chapter/Data for Markdown/"

```


```{r}

#Convert variables into right format
parasites %<>% mutate(id = factor(id),
                      sex = factor(sex),
                      post_hurricane = as.numeric(post_hurricane),
                      group_size = as.numeric(group_size),
                      season = factor(season),
                      age = as.numeric(age),
                      outrank_perc = as.numeric(outrank_perc))

#Define right censoring in balan_count (60 and above censored)
thres = 60 #define threshold
parasites %<>% mutate(cens = ifelse(balan_count == thres, "right","none"))#create column indicating censoring

#Excludes two males without agonistic data
parasites %<>% filter(!(status == ""))

#How many individuals with focal data?
table(parasites$group)/2 #54 + 16 =70, 30 in V

#How many individuals pre and post hurricane
table(parasites$post_hurricane)/2#54 pre and 46 post

#How many individuals in total?
length(unique(parasites$id))#100

#How many per sex?#66 F, 34 M
table(parasites$sex)/2

#Age range
min(parasites$age)
max(parasites$age)#4-26
mean(parasites$age)#10.7

#Histograms of counts
hist(parasites$balan_count, breaks = 20)#Protozoa
hist(parasites$count_nema, breaks = 20)#nematodes

#As we are asking about prevalence, which model the presence/absence, for abundance we can only consider individuals that are infected and omit the zeroes. So basically to ask, if an individual is infected, are there some attributes that makes them more susceptible?

#Exclude zeroes from counts
parasites %<>% mutate(nema_count_NZ = ifelse(count_nema == 0, NA, count_nema),
                      proto_count_NZ = ifelse(balan_count == 0, NA, balan_count))

hist(parasites$nema_count_NZ)#nematodes
hist(parasites$proto_count_NZ)#potozoas

```

Measures of parasite risk:
- Prevalence: number of hosts infected with one or more parasite divided by the number of hosts examined (one dependent variable % or ratio) [Bush et al., 1997]
*Only report for population pre and post hurricane.
- Presence/absence: presence or absence of infection per parasite species (3 binomial dependent variables)
- Intensity: number of parasites per type per infected host (2 count dependent variables: #nematodes or #protozoa excluding zeroes)

Measures of Sociality:
- Social status: agonistic observations from the three groups (males + females).
- Social connectedness: 
*Measures of risk: number of weak connections (degree < threshold) for grooming and proximity separately
*Measure of support: strength to top partners (upper quantile) for grooming and proximity separately
                     number of partners (degree) for grooming and proximity separately

Covariates:
- Age.
- Sex.
- Pre vs post-hurricane.
- Season (only V had samples collected through rainy and dry season. KK and HH samples were collected during rainy season only)

Analysis using BRMS

Descriptive statistics, prevalence overall and pre/post hurricane
```{r}
#FIRST REPORT PREVALENCE FOR EACH SPECIES OVERALL AND PRE AND POST-HURRICANE (prevalence = number of infected individuals over number of analysed hosts n = 100)

#Overall prevalence
length(unique(parasites$id[parasites$balan_present == 1]))#60/100 unique individuals infected with B.coli
length(unique(parasites$id[parasites$strongi_present == 1]))#23/100 unique individuals infected with S. fuelleborni
length(unique(parasites$id[parasites$trichu_present == 1]))#24/100 unique individuals infected with T. trichiura

#Prevalence pre and post hurricane
length(unique(parasites$id[parasites$post_hurricane == 0]))#54 animals sampled before hurricane and 46 after
#B coli
length(unique(parasites$id[parasites$balan_present == 1 & parasites$post_hurricane == 0]))#38/54 unique ind pre-hurricane 
length(unique(parasites$id[parasites$balan_present == 1 & parasites$post_hurricane == 1]))#22/46 unique ind post-hurricane
#Strongyloides
length(unique(parasites$id[parasites$strongi_present == 1 & parasites$post_hurricane == 0]))#8/54 unique ind pre-hurricane 
length(unique(parasites$id[parasites$strongi_present == 1 & parasites$post_hurricane == 1]))#15/46 unique ind post-hurricane
#Trichuris
length(unique(parasites$id[parasites$trichu_present == 1 & parasites$post_hurricane == 0]))#8/54 unique ind pre-hurricane
length(unique(parasites$id[parasites$trichu_present == 1 & parasites$post_hurricane == 1]))#16/46 unique ind post-hurricane

#How many individuals did not harbor any parasite?
x = parasites %>% group_by(id) %>% summarise(inf = sum(richness))
sum(x$inf == 0)#25 ind without parasites

```


Question1: Did the hurricane affect prevalence and intensity overall?

1A: Prevalence and intensity of B. coli
```{r}

#Prevalence
prev_coli = brm(data = parasites,
                family = bernoulli,
                balan_present ~  age*post_hurricane + sex + season + (1|id),
                cores = 4,
                prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                iter = 10000)

#Save model
#saveRDS(prev_coli, file = paste0(directory,"prev_coli.rds"))
prev_coli <- readRDS(paste0(directory,"prev_coli.rds"))#load model
pp_check(prev_coli)#looks okay

#Post-hoc test for significance of slopes
emm = emtrends(prev_coli, pairwise ~ post_hurricane, var = "age")
confint(emm, level = .89)
#Before hurricane: median = 0.44, 89%HPD = 0.0784, 0.842
#After hurricane: median = -0.274, 89%HPD = -0.6895, 0.106
#Before vs post at mean age = median 0.718, 89%HPD = 0.301 - 1.19


#Generate table with model output
tab_model(prev_coli,transform =  NULL, show.p = T, show.se = T, show.stat = T, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89,show.r2 = F)


#Intensity of infection
int_prot = brm(data = parasites,
                family = poisson(),
               #zero truncated and right censored
                proto_count_NZ|cens(cens) + trunc(lb = 0) ~  post_hurricane + season + scale(age)
                    + sex + (1|id),
                cores = 4,
                prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                iter = 10000)
#Save model
#saveRDS(int_prot, file = paste0(directory,"int_prot.rds"))

int_prot <- readRDS(paste0(directory,"int_prot.rds"))#load model
pp_check(int_prot)#looks okay

#Generate table with model output
tab_model(int_prot,transform =  NULL, show.p = T, show.se = T, show.stat = T, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89,show.r2 = F)

```


1B: Prevalence and intensity of nematode infection
```{r}

#Prevalence of S.fuelleborni
prev_strongi = brm(data = parasites,
                family = bernoulli,
                strongi_present ~  post_hurricane + sex + scale(age) + season + (1|id) ,
                cores = 4,
                prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                iter = 10000)#
#Save model
#saveRDS(prev_strongi, file = paste0(directory,"prev_strongi.rds"))

prev_strongi <- readRDS(paste0(directory,"prev_strongi.rds"))#load model
pp_check(prev_strongi)#looks okay

#Post-hoc test for significance of slopes
emm = emmeans(prev_strongi, pairwise ~ sex|post_hurricane)
confint(emm, level = .89)
#F vs M pre hurricane = median = 0.238, 89%HPD = -1.68, 2.582
#F vs M post hurricane = median = -3.043, 89%HPD = -5.59, -0.582
emm = emmeans(prev_strongi, pairwise ~ post_hurricane|sex)
confint(emm, level = .89)
#Males pre vs post = median = -4.08, 89%HPD = -7.16, -1.4
#Females pre vs post = median = -0.71, 89% HPD = -2.83, 1.07


#Generate table with model output
tab_model(prev_strongi,transform =  NULL, show.p = T, show.se = T, show.stat = T, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89,show.r2 = F)

#Prevalence of T. trichiura infection
prev_trichu = brm(data = parasites,
                family = bernoulli,
                trichu_present ~  post_hurricane + scale(age) + sex + season + (1|id) ,
                cores = 4,
                prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                iter = 10000)#
#Save model
#saveRDS(prev_trichu, file = paste0(directory,"prev_trichu.rds"))

prev_trichu <- readRDS(paste0(directory,"prev_trichu.rds"))#load model
pp_check(prev_trichu)#looks okay

#Generate table with model output
tab_model(prev_trichu,transform =  NULL, show.p = T, show.se = T, show.stat = T, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89,show.r2 = F)


#Intensity of nematode infection
int_nema =  brm(data = parasites,
                family = poisson(),
                bf(nema_count_NZ|trunc(lb = 0) ~  post_hurricane + season + sex + scale(age) 
                   + (1|id)),
                cores = 4,
               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                iter = 10000)#
#Save model
#saveRDS(int_nema, file = paste0(directory,"int_nema.rds"))

int_nema <- readRDS(paste0(directory,"int_nema.rds"))#load model
pp_check(int_nema)#looks okay

#Generate table with model output
tab_model(int_nema,transform =  NULL, show.p = T, show.se = T, show.stat = T, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89,show.r2 = F)

```



Question 2: Does being from higher status protects from parasites in the context of the hurricane and overall? 
2A: Prevalence and intensity of B. coli with social status
```{r}

#Does social status (outrank %) influence the prevalence of B. coli?
prev_coli_rank = brm(data = parasites,
                     family = bernoulli,
                     #Interaction with hurricane not significant
                     balan_present ~ scale(outrank_perc) + scale(age) + sex +  
                                      post_hurricane + season + (1|id),
                     cores = 4,
                  prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                  iter = 10000)#
#Save model
#saveRDS(prev_coli_rank, file = paste0(directory,"prev_coli_rank.rds"))

prev_coli_rank <- readRDS(paste0(directory,"prev_coli_rank.rds"))#load model
pp_check(prev_coli_rank)#looks okay

#Generate table with model output
tab_model(prev_coli_rank,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#Does social status influence the intensity of protozoa infection?
#Protozoa
int_prot_rank = brm(data = parasites,
                family = poisson(),
                #No effect of interction with hurricane
                proto_count_NZ|cens(cens) + trunc(lb = 0) ~  scale(outrank_perc) + post_hurricane + 
                  scale(age) + sex + season +
                  (1|id),
                cores = 4,
                prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                iter = 10000)
#Save model
#saveRDS(int_prot_rank, file = paste0(directory,"int_prot_rank.rds"))

int_prot_rank <- readRDS(paste0(directory,"int_prot_rank.rds"))#load model
pp_check(int_prot_rank)#looks okay

#Generate table with model output
tab_model(int_prot_rank,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#MODELS WITH INTERACTION FOR HURRICANE EFFECT
prev_coli_rankI = brm(data = parasites,
                     family = bernoulli,
                     balan_present ~ scale(outrank_perc)*post_hurricane + scale(age) + sex +  
                                      season + (1|id),
                     cores = 4,
                  prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                  iter = 10000)#
#Save model
#saveRDS(prev_coli_rankI, file = paste0(directory,"prev_coli_rankI.rds"))

prev_coli_rankI <- readRDS(paste0(directory,"prev_coli_rankI.rds"))#load model
pp_check(prev_coli_rankI)#looks okay

#Generate table with model output
tab_model(prev_coli_rankI,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)

#Intensity of infection
int_prot_rankI = brm(data = parasites,
                family = poisson(),
                #No effect of interction with hurricane
                proto_count_NZ|cens(cens) + trunc(lb = 0) ~  scale(outrank_perc)*post_hurricane + 
                  scale(age) + sex + season +
                  (1|id),
                cores = 4,
                prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                iter = 10000)
#Save model
saveRDS(int_prot_rankI, file = paste0(directory,"int_prot_rankI.rds"))

int_prot_rankI <- readRDS(paste0(directory,"int_prot_rankI.rds"))#load model
pp_check(int_prot_rankI)#looks okay

#Generate table with model output
tab_model(int_prot_rankI,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


```

2B: Prevalence and intensity of nematode infection with social status
```{r}

#Prevalence of S. fuelleborni
prev_strongi_rank = brm(data = parasites,
                     family = bernoulli,
                     #No effect of interaction with hurricane status
                     strongi_present ~ scale(outrank_perc) + scale(age) + sex +  
                                      post_hurricane + season + (1|id),
                     cores = 4,
                  prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                  iter = 10000)#
#Save model
#saveRDS(prev_strongi_rank, file = paste0(directory,"prev_strongi_rank.rds"))

prev_strongi_rank <- readRDS(paste0(directory,"prev_strongi_rank.rds"))#load model
pp_check(prev_strongi_rank)#looks okay

#Generate table with model output
tab_model(prev_strongi_rank,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#Prevalence of S. fuelleborni interaction
prev_strongi_rankI= brm(data = parasites,
                     family = bernoulli,
                     strongi_present ~ scale(outrank_perc)*post_hurricane + scale(age) + sex  
                                       + season + (1|id),
                     cores = 4,
                  prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                  iter = 10000)#
#Save model
#saveRDS(prev_strongi_rankI, file = paste0(directory,"prev_strongi_rankI.rds"))

prev_strongi_rankI <- readRDS(paste0(directory,"prev_strongi_rankI.rds"))#load model
pp_check(prev_strongi_rankI)#looks okay

#Generate table with model output
tab_model(prev_strongi_rankI,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#Prevalence of T. trichiura
prev_trichu_rank = brm(data = parasites,
                     family = bernoulli,
                     trichu_present ~ post_hurricane + scale(outrank_perc) + scale(age)+
                       sex + (1|id),
                     cores = 4,
                  prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                  iter = 10000)#No effect of rank

#Save model
#saveRDS(prev_trichu_rank, file = paste0(directory,"prev_trichu_rank.rds"))

prev_trichu_rank <- readRDS(paste0(directory,"prev_trichu_rank.rds"))#load model
pp_check(prev_trichu_rank)#looks okay

#Generate table with model output
tab_model(prev_trichu_rank,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)

#INTERACTION
prev_trichu_rankI = brm(data = parasites,
                     family = bernoulli,
                     trichu_present ~ post_hurricane*scale(outrank_perc) + scale(age)+
                       sex + (1|id),
                     cores = 4,
                  prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                  iter = 10000)

#Save model
#saveRDS(prev_trichu_rankI, file = paste0(directory,"prev_trichu_rankI.rds"))

prev_trichu_rankI <- readRDS(paste0(directory,"prev_trichu_rankI.rds"))#load model
pp_check(prev_trichu_rankI)#looks okay

#Generate table with model output
tab_model(prev_trichu_rankI,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)

#Intensity of nematode infection with social status
int_nema_rank =  brm(data = parasites,
                family = poisson(),
                bf(nema_count_NZ|trunc(lb = 0) ~  scale(outrank_perc) + post_hurricane + sex 
                   + scale(age) + season + (1|id)),
                cores = 4,
                prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                iter = 10000)#no effect
#Save model
#saveRDS(int_nema_rank, file = paste0(directory,"int_nema_rank.rds"))

int_nema_rank <- readRDS(paste0(directory,"int_nema_rank.rds"))#load model
pp_check(int_nema_rank)#looks okay

#Generate table with model output
tab_model(int_nema_rank,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)

#INTERACTION
int_nema_rankI =  brm(data = parasites,
                family = poisson(),
                bf(nema_count_NZ|trunc(lb = 0) ~  scale(outrank_perc)*post_hurricane + sex 
                   + scale(age) + season + (1|id)),
                cores = 4,
                prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                iter = 10000)#no effect
#Save model
saveRDS(int_nema_rankI, file = paste0(directory,"int_nema_rankI.rds"))

int_nema_rankI <- readRDS(paste0(directory,"int_nema_rankI.rds"))#load model
pp_check(int_nema_rankI)#looks okay

#Generate table with model output
tab_model(int_nema_rankI,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


```


Question 3: Does having more weak connections increase the risk of parasite transmission? For these models was not possible to account for hurricane effect as sample size post-hurricane is too small. Also, for the same reason we could not determine the effect on parasite intensity. 
```{r}
nets = sample(networks, 20)

#B COLI INFECTION RISK WITH GROOMING
prev_coli_weakG = brm_multiple(data = nets,
                               family = bernoulli,
                               balan_present ~ scale(weak_prox) + group + 
                                                (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 100)

#Save model
#saveRDS(prev_coli_weakG, file = paste0(directory,"prev_coli_weakG.rds"))

prev_coli_weakG <- readRDS(paste0(directory,"prev_coli_weakG.rds"))#load model
#pp_check(prev_coli_weakG)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_coli_weakG$rhats)

#Generate table with model output
tab_model(prev_coli_weakG,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#B COLI INFECTION RISK WITH PROXIMITY
prev_coli_weakP = brm_multiple(data = networks,
                               family = bernoulli,
                               balan_present ~ scale(std_weak_prox) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_coli_weakP, file = paste0(directory,"prev_coli_weakP.rds"))

prev_coli_weakP <- readRDS(paste0(directory,"prev_coli_weakP.rds"))#load model
pp_check(prev_coli_weakP)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_coli_weakP$rhats)

#Generate table with model output
tab_model(prev_coli_weakP,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#S. FUELLEBORNI INFECTION RISK WITH GROOMING
prev_strongi_weakG = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_weak_groom) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_strongi_weakG, file = paste0(directory,"prev_strongi_weakG.rds"))

prev_strongi_weakG <- readRDS(paste0(directory,"prev_strongi_weakG.rds"))#load model
pp_check(prev_strongi_weakG)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_strongi_weakG$rhats)

#Generate table with model output
tab_model(prev_strongi_weakG,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#S. FUELLEBORNI INFECTION RISK WITH PROXIMITY
prev_strongi_weakP = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_weak_prox) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_strongi_weakP, file = paste0(directory,"prev_strongi_weakP.rds"))

prev_strongi_weakP <- readRDS(paste0(directory,"prev_strongi_weakP.rds"))#load model
pp_check(prev_strongi_weakP)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_strongi_weakP$rhats)

#Generate table with model output
tab_model(prev_strongi_weakP,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#T. TRICHIURA INFECTION RISK WITH GROOMING
prev_trichu_weakG = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_weak_groom) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_trichu_weakG, file = paste0(directory,"prev_trichu_weakG.rds"))

prev_trichu_weakG <- readRDS(paste0(directory,"prev_trichu_weakG.rds"))#load model
pp_check(prev_trichu_weakG)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_trichu_weakG$rhats)

#Generate table with model output
tab_model(prev_trichu_weakG,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#T. TRICHIURA INFECTION RISK WITH PROXIMITY
prev_trichu_weakP = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_weak_prox) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_trichu_weakP, file = paste0(directory,"prev_trichu_weakP.rds"))

prev_trichu_weakP <- readRDS(paste0(directory,"prev_trichu_weakP.rds"))#load model
pp_check(prev_trichu_weakP)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_trichu_weakP$rhats)


#Generate table with model output
tab_model(prev_trichu_weakP,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


```


Question 4: Does having stronger social connections protects against infections? For these models was not possible to account for hurricane effect as sample size post-hurricane is too small. Also, for the same reason we could not determine the effect on parasite intensity. 
```{r}
#B COLI INFECTION RISK WITH GROOMING
prev_coli_strG = brm_multiple(data = networks,
                               family = bernoulli,
                               balan_present ~ scale(std_topstr_groom) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_coli_strG, file = paste0(directory,"prev_coli_strG.rds"))

prev_coli_strG <- readRDS(paste0(directory,"prev_coli_strG.rds"))#load model
pp_check(prev_coli_strG)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_coli_strG$rhats)

#Generate table with model output
tab_model(prev_coli_strG,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#B COLI INFECTION RISK WITH GROOMING
prev_coli_strP = brm_multiple(data = networks,
                               family = bernoulli,
                               balan_present ~ scale(std_topstr_prox) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                              prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_coli_strP, file = paste0(directory,"prev_coli_strP.rds"))

prev_coli_strP <- readRDS(paste0(directory,"prev_coli_strP.rds"))#load model
pp_check(prev_coli_strP)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_coli_strP$rhats)

#Generate table with model output
tab_model(prev_coli_strP,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#S. FUELLEBORNI INFECTION RISK WITH GROOMING
prev_strongi_strG = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_topstr_groom) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_strongi_strG, file = paste0(directory,"prev_strongi_strG.rds"))

prev_strongi_strG <- readRDS(paste0(directory,"prev_strongi_strG.rds"))#load model
pp_check(prev_strongi_strG)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_strongi_strG$rhats)

#Generate table with model output
tab_model(prev_strongi_strG,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#S. FUELLEBORNI INFECTION RISK WITH PROXIMITY
prev_strongi_strP = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_topstr_prox) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_strongi_strP, file = paste0(directory,"prev_strongi_strP.rds"))

prev_strongi_strP <- readRDS(paste0(directory,"prev_strongi_strP.rds"))#load model
pp_check(prev_strongi_strP)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_strongi_strP$rhats)


#Generate table with model output
tab_model(prev_strongi_strP,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#T. TRICHIURA INFECTION RISK WITH GROOMING
prev_trichu_strG = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_topstr_groom) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_trichu_strG, file = paste0(directory,"prev_trichu_strG.rds"))

prev_trichu_strG <- readRDS(paste0(directory,"prev_trichu_strG.rds"))#load model
pp_check(prev_trichu_strG)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_strongi_strP$rhats)

#Generate table with model output
tab_model(prev_trichu_strG,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#T. TRICHIURA INFECTION RISK WITH PROXIMITY
prev_trichu_strP = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_topstr_prox) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_trichu_strP, file = paste0(directory,"prev_trichu_strP.rds"))

prev_trichu_strP <- readRDS(paste0(directory,"prev_trichu_strP.rds"))#load model
pp_check(prev_trichu_strP)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_strongi_strP$rhats)


#Generate table with model output
tab_model(prev_trichu_strP,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


```

SUPPLEMENTARY ANALYSES

Testing the effect of degree on infection risk.
```{r}
#B COLI INFECTION RISK WITH GROOMING
prev_coli_degG = brm_multiple(data = networks,
                               family = bernoulli,
                               balan_present ~ scale(std_deg_groom) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_coli_degG, file = paste0(directory,"prev_coli_degG.rds"))

prev_coli_degG <- readRDS(paste0(directory,"prev_coli_degG.rds"))#load model
pp_check(prev_coli_degG)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_coli_degG$rhats)

#Generate table with model output
tab_model(prev_coli_degG,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#B COLI INFECTION RISK WITH GROOMING
prev_coli_degP = brm_multiple(data = networks,
                               family = bernoulli,
                               balan_present ~ scale(std_deg_prox) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_coli_degP, file = paste0(directory,"prev_coli_degP.rds"))

prev_coli_degP <- readRDS(paste0(directory,"prev_coli_degP.rds"))#load model
pp_check(prev_coli_degP)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_coli_degP$rhats)

#Generate table with model output
tab_model(prev_coli_degP,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#S. FUELLEBORNI INFECTION RISK WITH GROOMING
prev_strongi_degG = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_deg_groom) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_strongi_degG, file = paste0(directory,"prev_strongi_degG.rds"))

prev_strongi_degG <- readRDS(paste0(directory,"prev_strongi_degG.rds"))#load model
pp_check(prev_strongi_degG)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_strongi_degG$rhats)

#Generate table with model output
tab_model(prev_strongi_degG,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#S. FUELLEBORNI INFECTION RISK WITH PROXIMITY
prev_strongi_degP = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_deg_prox) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_strongi_degP, file = paste0(directory,"prev_strongi_degP.rds"))

prev_strongi_degP <- readRDS(paste0(directory,"prev_strongi_degP.rds"))#load model
pp_check(prev_strongi_degP)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_strongi_degP$rhats)


#Generate table with model output
tab_model(prev_strongi_degP,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#T. TRICHIURA INFECTION RISK WITH GROOMING
prev_trichu_degG = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_deg_groom) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_trichu_degG, file = paste0(directory,"prev_trichu_degG.rds"))

prev_trichu_degG <- readRDS(paste0(directory,"prev_trichu_degG.rds"))#load model
pp_check(prev_trichu_degG)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_trichu_degG$rhats)

#Generate table with model output
tab_model(prev_trichu_degG,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#T. TRICHIURA INFECTION RISK WITH PROXIMITY
prev_trichu_degP = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_deg_prox) + scale(perc_rank) +
                                               scale(age) + sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_trichu_degP, file = paste0(directory,"prev_trichu_degP.rds"))

prev_trichu_degP <- readRDS(paste0(directory,"prev_trichu_degP.rds"))#load model
pp_check(prev_trichu_degP)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_trichu_degP$rhats)


#Generate table with model output
tab_model(prev_trichu_degP,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)





```

Remove parameters for models on prevalence for nematode parasites.
```{r}

#First run univariate models to test effects and see which parameter to keep/remove
#Strongyloides and sex
strongi_sex = brm(data = parasites,
                     family = bernoulli,
                               strongi_present ~  sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(strongi_sex, file = paste0(directory,"strongi_sex.rds"))

#Generate table with model output
tab_model(strongi_sex,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#Strongyloides and age
strongi_age = brm(data = parasites,
                     family = bernoulli,
                               strongi_present ~  scale(age) + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(strongi_age, file = paste0(directory,"strongi_age.rds"))

#Generate table with model output
tab_model(strongi_age,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#Strongyloides and rank
strongi_rank = brm(data = parasites,
                     family = bernoulli,
                               strongi_present ~  scale(outrank_perc) + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(strongi_rank, file = paste0(directory,"strongi_rank.rds"))

#Generate table with model output
tab_model(strongi_rank,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)

#Trichuris and sex
trichu_sex = brm(data = parasites,
                     family = bernoulli,
                               trichu_present ~  sex + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)
#Save model
#saveRDS(trichu_sex, file = paste0(directory,"trichu_sex.rds"))

#Generate table with model output
tab_model(trichu_sex,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)

#Trichuris and age
trichu_age = brm(data = parasites,
                     family = bernoulli,
                               trichu_present ~  scale(age) + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(trichu_age, file = paste0(directory,"trichu_age.rds"))

#Generate table with model output
tab_model(trichu_age,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#Trichuris and rank
trichu_rank = brm(data = parasites,
                     family = bernoulli,
                               trichu_present ~  scale(outrank_perc) + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(trichu_rank, file = paste0(directory,"trichu_rank.rds"))

#Generate table with model output
tab_model(trichu_rank,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


###WEAK PARTNERS##
#S. FUELLEBORNI INFECTION RISK WITH GROOMING
prev_strongi_weakG2 = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_weak_groom) + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_strongi_weakG2, file = paste0(directory,"prev_strongi_weakG2.rds"))

prev_strongi_weakG2 <- readRDS(paste0(directory,"prev_strongi_weakG2.rds"))#load model
pp_check(prev_strongi_weakG2)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_strongi_weakG2$rhats)

#Generate table with model output
tab_model(prev_strongi_weakG2,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#S. FUELLEBORNI INFECTION RISK WITH PROXIMITY
prev_strongi_weakP2 = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_weak_prox)  + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_strongi_weakP2, file = paste0(directory,"prev_strongi_weakP2.rds"))

prev_strongi_weakP2 <- readRDS(paste0(directory,"prev_strongi_weakP2.rds"))#load model
pp_check(prev_strongi_weakP2)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_strongi_weakP2$rhats)

#Generate table with model output
tab_model(prev_strongi_weakP2,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#T. TRICHIURA INFECTION RISK WITH GROOMING
prev_trichu_weakG2 = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_weak_groom) + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_trichu_weakG2, file = paste0(directory,"prev_trichu_weakG2.rds"))

prev_trichu_weakG2 <- readRDS(paste0(directory,"prev_trichu_weakG2.rds"))#load model
pp_check(prev_trichu_weakG2)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_trichu_weakG2$rhats)

#Generate table with model output
tab_model(prev_trichu_weakG2,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#T. TRICHIURA INFECTION RISK WITH PROXIMITY
prev_trichu_weakP2 = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_weak_prox) + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_trichu_weakP2, file = paste0(directory,"prev_trichu_weakP2.rds"))

prev_trichu_weakP2 <- readRDS(paste0(directory,"prev_trichu_weakP2.rds"))#load model
pp_check(prev_trichu_weakP2)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_trichu_weakP2$rhats)

#Generate table with model output
tab_model(prev_trichu_weakP2,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


###STRENGTH TO STRONG PARTNERS##
#S. FUELLEBORNI INFECTION RISK WITH GROOMING
prev_strongi_strG2 = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_topstr_groom) + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_strongi_strG2, file = paste0(directory,"prev_strongi_strG2.rds"))

prev_strongi_strG2 <- readRDS(paste0(directory,"prev_strongi_strG2.rds"))#load model
pp_check(prev_strongi_strG2)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_strongi_strG2$rhats)

#Generate table with model output
tab_model(prev_strongi_strG2,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#S. FUELLEBORNI INFECTION RISK WITH PROXIMITY
prev_strongi_strP2 = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_topstr_prox)  + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_strongi_strP2, file = paste0(directory,"prev_strongi_strP2.rds"))

prev_strongi_strP2 <- readRDS(paste0(directory,"prev_strongi_strP2.rds"))#load model
pp_check(prev_strongi_strP2)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_strongi_strP2$rhats)

#Generate table with model output
tab_model(prev_strongi_strP2,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#T. TRICHIURA INFECTION RISK WITH GROOMING
prev_trichu_strG2 = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_topstr_groom) + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_trichu_strG2, file = paste0(directory,"prev_trichu_strG2.rds"))

prev_trichu_strG2 <- readRDS(paste0(directory,"prev_trichu_strG2.rds"))#load model
pp_check(prev_trichu_strG2)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_trichu_strG2$rhats)

#Generate table with model output
tab_model(prev_trichu_strG2,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)


#T. TRICHIURA INFECTION RISK WITH PROXIMITY
prev_trichu_strP2 = brm_multiple(data = networks,
                               family = bernoulli,
                               strongi_present ~ scale(std_topstr_groom) + (1|id),
                               cores = 4,
                               prior = c(prior(student_t(5, 0, 2.5), class = "b")),
                               iter = 1000)

#Save model
#saveRDS(prev_trichu_strP2, file = paste0(directory,"prev_trichu_strP2.rds"))

prev_trichu_strP2 <- readRDS(paste0(directory,"prev_trichu_strP2.rds"))#load model
pp_check(prev_trichu_strP2)#looks okay
#Rhat needs to be checked differently for models with Bison networks
max(prev_trichu_strP2$rhats)

#Generate table with model output
tab_model(prev_trichu_strP2,transform =  NULL, show.p = T, show.se = T, show.stat = F, show.icc = F, show.re.var = F, dv.labels = "Infection risk",
          show.ci = 0.89, show.r2 = F)



```


FIGURES

Figure 1: Effect of hurricane on parasite prevalence
```{r}

#Fig 1A: PREVALENCE OF B.COLI WITH AGE
prev_coli <- readRDS(paste0(directory,"prev_coli.rds"))#Load model 

#Bottom panel (effect)
plot1 = conditional_effects(prev_coli, effects ="age:post_hurricane", 
                            prob = 0.89)[[1]]
plot1 %<>% rename(prob_ev = estimate__, se = se__)

#Set probabilities on scale of y axis
parasites %<>% mutate(bcoli1 = ifelse(balan_present == 1, 1.05, -0.05))

Fig1A = plot1 %>% ggplot(aes(x = age, color = post_hurricane)) +
          geom_line(aes(y = prob_ev, linetype = post_hurricane), size = 1.5) +
          geom_ribbon(aes(ymin= lower__, ymax= upper__, fill= post_hurricane, color = NULL),alpha=0.3) + 
          geom_jitter(data = parasites,
                      aes(y = bcoli1 ), colour = "antiquewhite4",
                      size = 4, alpha = 0.2, height = 0.0007) +
         scale_fill_manual(values = c("grey","bisque4"), labels = c("Pre","Post")) +
         scale_color_manual(values = c("grey60","bisque4"),labels = c("Pre","Post")) +
         scale_linetype(labels = c("Pre","Post"))+
         scale_x_continuous(breaks = seq(0,30,5)) +
         scale_y_continuous(breaks=seq(0,1,0.5)) +
         theme_bw() +
         labs(x = "Age (years)", y = "B. coli infection risk", fill = "Hurricane", 
        linetype = "Hurricane", colour ="Hurricane") +
        theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
        text = element_text(size = 18))


#Fig 1B: PREVALENCE OF STRONGYLOIDES WITH SEX
prev_strongi <- readRDS(paste0(directory,"prev_strongi.rds"))#Load model 

plot1 = conditional_effects(prev_strongi, effects = "post_hurricane:sex", prob = 0.89)

Fig1B = plot(plot1, plot = FALSE)[[1]] +
  #scale_fill_manual(values = c("aquamarine4","coral1"), labels = c("Females","Males")) +
  scale_color_manual(values = c("darkgoldenrod3","black"), labels = c("Females","Males")) +
  theme_bw() +
  labs(x = "Hurricane", y = "S. fuelleborni infection risk", 
       colour = "Sex") + scale_x_discrete(labels = c("Pre","Post"))+ ylim(0,1) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
        text = element_text(size = 18))

#Figure 1C: prevalence of T. Trichiura
prev_trichu <- readRDS(paste0(directory,"prev_trichu.rds"))#Load model
#Extract posterior
plot1 = conditional_effects(prev_trichu, effects = "post_hurricane", prob = 0.89)

Fig1C = plot(plot1, plot = FALSE)[[1]] +
  theme_bw() +
  labs(x = "Hurricane", y = "T. trichiura infection risk") + scale_x_discrete(labels = c("Pre","Post")) + ylim(0,0.4) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
        text = element_text(size = 18))

```

Fig 2: Bison Networks
```{r}




```


Fig 4: Effect of weak and strong connections on B. coli infection
```{r}

prev_coli_weakP <- readRDS(paste0(directory,"prev_coli_weakP.rds"))#Load mode

#Fig4A: weak connections in proximity network
draws = as_draws_df(prev_coli_weakP)
length = 200
n_draw = 20

#Subset from networks
nets = networks[[1]]
#Remove draws outside 89% CI
draws %<>% filter(!(b_scalestd_weak_prox > quantile(b_scalestd_weak_prox, 0.945)|b_scalestd_weak_prox < quantile(b_scalestd_weak_prox, 0.055)))

post1 = draws %>%
  tibble() %>%
  slice_sample(n = n_draw) %>%
  expand(nesting(.draw, b_Intercept,b_scalestd_weak_prox),
         scaled_weak_prox = seq(-2, to = 2, length.out = length)) %>%
  mutate(event = inv_logit_scaled(b_Intercept + b_scalestd_weak_prox*scaled_weak_prox),
         weak_prox = scaled_weak_prox*sd(nets$std_weak_prox) + mean(nets$std_weak_prox)) %>%
  select(.draw,event,weak_prox)


#Convert infection events to scale of y-axis
nets %<>% mutate(event1 = ifelse(balan_present == 1, 1.1, -0.1)) %>% 
  select(-weak_prox) %>% rename(weak_prox = std_weak_prox)
        
med = post1 %>% group_by(weak_prox) %>% summarise(med = median(event))


Fig3A =  post1 %>%
  ggplot(aes(x = weak_prox)) +
  geom_line(aes(y = event, group = .draw),
            color = "goldenrod2", size = 4, alpha = 0.08) +
  geom_point(data = med, aes(y = med), size = 1.5, colour ="goldenrod2" ) +
  geom_jitter(data = nets,
              aes(y = event1), colour = "antiquewhite4",
              size = 4, alpha = 0.2, height = 0.0007)  +
  xlab("Number of weak partners") + ylab("B. coli infection risk") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
        text = element_text(size = 18),
        axis.text.y=element_text(size=15),axis.text.x=element_text(size=15)) 

#FIG3B:strength to strong connection in proximity network
prev_coli_strP <- readRDS(paste0(directory,"prev_coli_strP.rds"))#Load mode

draws = as_draws_df(prev_coli_strP)
length = 200
n_draw = 25

#Subset from networks
nets = networks[[1]]
#Remove draws outside 89% CI
draws %<>% filter(!(b_scalestd_topstr_prox > quantile(b_scalestd_topstr_prox, 0.945)|b_scalestd_topstr_prox < quantile(b_scalestd_topstr_prox, 0.055)))

post1 = draws %>%
  tibble() %>%
  slice_sample(n = n_draw) %>%
  expand(nesting(.draw, b_Intercept,b_scalestd_topstr_prox),
         scaled_str_prox = seq(-1.2, to = 2.8, length.out = length)) %>%
  mutate(event = inv_logit_scaled(b_Intercept + b_scalestd_topstr_prox*scaled_str_prox),
         str_prox = scaled_str_prox*sd(nets$std_topstr_prox) + mean(nets$std_topstr_prox)) %>%
  select(.draw,event,str_prox)


#Convert infection events to scale of y-axis
nets %<>% mutate(event1 = ifelse(balan_present == 1, 1.1, -0.1)) %>%
          rename(str_prox = std_topstr_prox)
med = post1 %>% group_by(str_prox) %>% summarise(med = median(event))


Fig3B =  post1 %>%
  ggplot(aes(x = str_prox)) +
  geom_line(aes(y = event, group = .draw),
            color = "goldenrod2", size = 4, alpha = 0.08) +
  geom_point(data = med, aes(y = med), size = 1.5, colour ="goldenrod2" ) +
  geom_jitter(data = nets,
              aes(y = event1), colour = "antiquewhite4",
              size = 4, alpha = 0.2, height = 0.0007)  +
  xlab("Strength to strong partners") + ylab("B. coli infection risk") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
        text = element_text(size = 18),
        axis.text.y=element_text(size=15),axis.text.x=element_text(size=15)) 

```


Figure S1: distributions of edge weights and threshold
```{r}

list_edges = c("HH_edgelist","KK_edgelist")
group_years = c("HH2016","KK2018")

for(i in 1:length(list_edges)){
   edges = read.csv(paste0(dir_edges,group_years[i],"/",list_edges[i],".csv"))
   if(group_years[i] == "HH2016"){
   groom_thres = edges %>% mutate(groom_events = as.integer(groom_dur/300),#300 = focal length
                                  samp_effT = samp_effT*3600,#convert to seconds
                                  total_obs_events = floor(samp_effT/300),
                                  weight = groom_events/total_obs_events) %>%
                filter(!(weight == 0)) %>% summarise(threshold = min(weight))
   groom_thres = round(groom_thres$threshold,digits = 5)
   prox_thres =  edges %>% mutate(weight = obs_together/samp_effC) %>% 
                            filter(!(weight == 0)) %>% summarise(threshold = min(weight))
   prox_thres = round(prox_thres$threshold,digits = 5)
   }
   else{
   groom_thres = edges %>%  mutate(weight = groom_together/samp_effC) %>%
                            filter(!(weight == 0)) %>% summarise(threshold = min(weight))
   groom_thres = round(groom_thres$threshold,digits = 5)
   prox_thres =  edges %>% mutate(weight = prox_together/samp_effC) %>% 
                            filter(!(weight == 0)) %>% summarise(threshold = min(weight))
   prox_thres = round(prox_thres$threshold,digits = 5)
   }
  assign(paste0(group_years[i],"groom_thres"), groom_thres) 
  assign(paste0(group_years[i],"prox_thres"), prox_thres) 
}

#PLOT (requires laading bison networks)
#Define network
fit_edge = fit_groomHH
threshold_net = thres_HH_groom
#Extract 50 random draws from bison edge model
draws = 100
weights = data.frame(value = as.numeric())

for(i in 1:draws){
temp = data.frame(value = plogis(fit_edge$edge_samples[i,]))
weights = rbind(weights,temp)
  }

#weights goes up to 60 decimals so need to be rounded
weights$value = round(weights$value,digits = 4)

#Find threshold for strong partners excluding non-interacting dyads
thres_str = round(quantile(weights[weights >= threshold_net], 0.75), digits = 4)

###Plot with ggplot
max_x = max(weights$value)
#Plot
ggplot(weights, aes(x = value)) +
  geom_density(colour = "gray48",fill= "orange2", alpha = .7)+
  xlab("Edge weights") + ylab("Count") + 
  scale_x_continuous(breaks = seq(0,max_x, 0.02)) +
  scale_y_continuous(expand = c(0.01,0)) + 
  geom_vline(xintercept = c(threshold_net,#Thresold dyad exist or not
                            thres_str),#Threshold for strong partners (3rd quantile excluding zero)
             size = c(0.4, 0.4),
             lty = c(2,2), color = c("black","red"))+ 
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  
rm(fit_edge,temp,weights,priors)

```


Figure S2: correlation between measures of sociality from Bison
```{r}

#Get values from 20 draws from each posterior
net_metrics = data.frame(prox_weak = "",
                         groom_weak = "",
                         prox_str = "",
                         groom_str = "",
                         prox_deg = "",
                         groom_deg = "")

n_draws = 20

for(k in 1:n_draws){
   post_n = networks[[k]]
   temp  = data.frame(prox_weak = rep("", 140),
                      groom_weak = rep("", 140),
                      prox_str = rep("", 140),
                      groom_str = rep("", 140),
                      prox_deg = rep("", 140),
                      groom_deg = rep("", 140))
   
   temp$prox_weak = post_n$std_weak_prox
   temp$groom_weak = post_n$std_weak_groom
   temp$prox_str = post_n$std_topstr_prox
   temp$groom_str = post_n$std_topstr_groom
   temp$prox_deg = post_n$std_deg_prox
   temp$groom_deg = post_n$std_deg_groom
   
   net_metrics = rbind(net_metrics,temp)
}

net_metrics = net_metrics[-1,]
net_metrics %<>% mutate_if(is.character, as.numeric)


#Plot correlogram
library(corrplot)
cor.mat1 <- net_metrics %>% select(prox_weak, groom_weak, prox_str, groom_str, prox_deg, groom_deg)
M <- cor(cor.mat1, method = "pearson", use = "complete.obs")
corrplot.mixed(M, order = "hclust",tl.col = "black", tl.srt = 45)

```





